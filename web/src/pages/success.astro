---
import Layout from '../layouts/Layout.astro';
---

<Layout title="The Molt Pit — Founder Spot Confirmed" description="Your Molt Pit Founder checkout is complete. Next steps for alpha access inside.">
  <main class="shell">
    <section class="panel success">
      <p class="eyebrow">PAYMENT CONFIRMED</p>
      <h1>You’re in — Founder spot reserved.</h1>
      <p>
        Thanks for backing The Molt Pit early. We’re preparing your founder onboarding email with alpha queue details,
        rank-season kickoff timing, and tournament invite priority.
      </p>

      <div class="next-steps">
        <article>
          <strong>1) Check your inbox</strong>
          <span>Look for your Stripe receipt + The Molt Pit onboarding within 24 hours.</span>
        </article>
        <article>
          <strong>2) Join waitlist backup</strong>
          <span>If checkout used a different email, submit your preferred inbox on the homepage.</span>
        </article>
      </div>

      <div class="actions">
        <a class="button button-primary" href="/">Back to homepage</a>
        <a class="button button-secondary" href="/#join">Add backup email</a>
      </div>

      <p class="fine-print">Need help? Reply to your Stripe receipt and we’ll fix your founder access manually.</p>
    </section>
  </main>
</Layout>

<script is:inline>
  const key = 'moltpit_paid_conversions';
  const pendingKey = 'moltpit_pending_paid_conversions';

  function rememberPaidConversion(id) {
    const known = JSON.parse(localStorage.getItem(key) || '[]');
    if (!known.includes(id)) {
      known.push(id);
      localStorage.setItem(key, JSON.stringify(known.slice(-200)));
    }
  }

  function hasPaidConversion(id) {
    const known = JSON.parse(localStorage.getItem(key) || '[]');
    return known.includes(id);
  }

  function rememberPending(payload) {
    if (!payload?.eventId) return;
    const queue = JSON.parse(localStorage.getItem(pendingKey) || '[]');
    const deduped = queue.filter((entry) => entry?.eventId !== payload.eventId);
    deduped.push(payload);
    localStorage.setItem(pendingKey, JSON.stringify(deduped.slice(-50)));
  }

  function clearPending(eventId) {
    const queue = JSON.parse(localStorage.getItem(pendingKey) || '[]');
    const next = queue.filter((entry) => entry?.eventId !== eventId);
    localStorage.setItem(pendingKey, JSON.stringify(next));
  }

  async function postConversion(payload) {
    const body = JSON.stringify(payload);

    try {
      const response = await fetch('/api/checkout-success', {
        method: 'POST',
        headers: {
          'content-type': 'application/json',
          Accept: 'application/json',
        },
        body,
        keepalive: true,
      });
      if (response.ok) return true;
    } catch {
      // Fall through to beacon.
    }

    try {
      return navigator.sendBeacon('/api/checkout-success', new Blob([body], { type: 'application/json' }));
    } catch {
      return false;
    }
  }

  async function flushPendingConversions() {
    const queue = JSON.parse(localStorage.getItem(pendingKey) || '[]');
    if (!Array.isArray(queue) || queue.length === 0) return;

    for (const payload of queue) {
      if (!payload?.eventId || hasPaidConversion(payload.eventId)) {
        clearPending(payload?.eventId);
        continue;
      }
      const ok = await postConversion(payload);
      if (ok) {
        rememberPaidConversion(payload.eventId);
        clearPending(payload.eventId);
      }
    }
  }

  async function trackPaidConversion() {
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('session_id') || params.get('checkout_session_id');
    const email = params.get('prefilled_email') || localStorage.getItem('moltpit_email') || undefined;
    const conversionId = sessionId || `success:${window.location.pathname}:${new Date().toISOString().slice(0, 10)}`;

    if (hasPaidConversion(conversionId)) return;

    const checkoutSource = localStorage.getItem('moltpit_last_founder_checkout_source') || 'stripe-success';
    const checkoutIntentSource = localStorage.getItem('moltpit_last_founder_intent_source') || undefined;

    const payload = {
      eventId: conversionId,
      page: window.location.pathname,
      href: window.location.href,
      source: checkoutSource,
      tier: 'founder',
      email,
      meta: {
        sessionId,
        url: window.location.href,
        checkoutSource,
        checkoutIntentSource,
      },
    };

    const ok = await postConversion(payload);
    if (ok) {
      rememberPaidConversion(conversionId);
      clearPending(conversionId);
      return;
    }

    rememberPending(payload);
  }

  flushPendingConversions().finally(() => {
    trackPaidConversion();
  });
</script>

<style>
  .shell {
    max-width: 920px;
    margin: 0 auto;
    padding: 1.75rem 1.25rem 4rem;
  }

  .panel {
    margin-top: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 1rem;
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.03);
  }

  .success {
    max-width: 760px;
  }

  .eyebrow {
    color: #9ca5ff;
    font-size: 0.78rem;
    letter-spacing: 0.12em;
    font-weight: 700;
  }

  h1 {
    margin: 0.4rem 0 1rem;
    line-height: 1.12;
    font-size: clamp(1.9rem, 4.2vw, 3rem);
  }

  p {
    color: #d0d5ef;
    line-height: 1.55;
  }

  .next-steps {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 0.85rem;
    margin: 1.4rem 0;
  }

  .next-steps article {
    border: 1px solid rgba(255, 255, 255, 0.13);
    border-radius: 0.8rem;
    padding: 0.85rem;
    background: rgba(0, 0, 0, 0.25);
  }

  .next-steps strong {
    display: block;
    margin-bottom: 0.3rem;
  }

  .next-steps span {
    color: #c8cdea;
    font-size: 0.92rem;
    line-height: 1.45;
  }

  .actions {
    display: flex;
    gap: 0.7rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }

  .button {
    border: 0;
    text-decoration: none;
    border-radius: 999px;
    padding: 0.72rem 1.2rem;
    font-weight: 700;
    cursor: pointer;
    display: inline-flex;
    justify-content: center;
    align-items: center;
  }

  .button-primary {
    background: linear-gradient(135deg, #8a8fff 0%, #5d6bff 100%);
    color: white;
  }

  .button-secondary {
    background: rgba(255, 255, 255, 0.08);
    color: #f4f5ff;
    border: 1px solid rgba(255, 255, 255, 0.16);
  }

  .fine-print {
    margin-top: 0.9rem;
    color: #acb2d9;
    font-size: 0.84rem;
  }
</style>
