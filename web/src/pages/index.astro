---
import Layout from '../layouts/Layout.astro';

const founderCheckoutUrl =
  import.meta.env.PUBLIC_STRIPE_FOUNDER_URL ?? 'https://buy.stripe.com/test_4gw4gA8kQ8PU0j6dQQ';
const proWaitlistUrl = import.meta.env.PUBLIC_PRO_WAITLIST_URL ?? '#join';
const tournamentWaitlistUrl = import.meta.env.PUBLIC_TOURNAMENT_WAITLIST_URL ?? '#join';
---

<Layout title="CogCage — Join the Alpha" description="A skill-first AI arena with ranked ladders, founder access, and competitive tournaments.">
  <main class="shell">
    <header class="topbar">
      <a href="#" class="logo">COGCAGE</a>
      <a class="ghost" href="#pricing" data-track="view_pricing">Pricing</a>
    </header>

    <section class="hero">
      <p class="eyebrow">SKILL-FIRST AI COMPETITION</p>
      <h1>Climb the ladder. Beat real opponents. Earn your edge.</h1>
      <p class="subcopy">
        CogCage is the competitive arena for AI-assisted strategy players. Join the alpha to lock founder pricing,
        get early ranked access, and first invites to entry-fee tournaments.
      </p>

      <div class="cta-row">
        <a class="button button-primary" href="#join" data-track="hero_join_click">Join Alpha</a>
        <a class="button button-secondary" href="#pricing" data-track="hero_pricing_click">See Plans</a>
      </div>

      <div class="stats">
        <article>
          <strong>Founder price</strong>
          <span>$9/mo locked for first 200 members</span>
        </article>
        <article>
          <strong>Tournament access</strong>
          <span>Priority entry invites for alpha cohort</span>
        </article>
        <article>
          <strong>Launch focus</strong>
          <span>Ranked 1v1 ladders + replay analytics</span>
        </article>
      </div>
    </section>

    <section class="panel" id="pricing">
      <h2>Simple pricing ladder</h2>
      <p>Start with founder access now. Upgrade to Pro for higher caps and analytics once ranked queues open.</p>
      <div class="cards">
        <article class="card card-highlight">
          <h3>Founder</h3>
          <p class="price">$9<span>/month</span></p>
          <ul>
            <li>Alpha queue access</li>
            <li>Monthly rank seasons</li>
            <li>Founder badge + locked pricing</li>
          </ul>
          <form class="founder-checkout-form" id="founderCheckoutForm" data-checkout-url={founderCheckoutUrl}>
            <label>
              Email for instant checkout
              <input
                type="email"
                name="email"
                autocomplete="email"
                placeholder="you@domain.com"
                required
              />
            </label>
            <button
              type="submit"
              class="button button-primary"
              data-track="founder_checkout_click"
              data-checkout-tier="founder"
            >
              Reserve Founder Spot — Checkout
            </button>
          </form>
        </article>
        <article class="card">
          <h3>Pro</h3>
          <p class="price">$29<span>/month</span></p>
          <ul>
            <li>Higher match caps</li>
            <li>Replay + trend analytics</li>
            <li>Priority support + events</li>
          </ul>
          <a href={proWaitlistUrl} class="button button-secondary" data-track="pro_interest_click">Get Notified</a>
        </article>
        <article class="card">
          <h3>Tournaments</h3>
          <p class="price">$5–$25<span>/entry</span></p>
          <ul>
            <li>Prize-pool challenge nights</li>
            <li>Skill-tier matchmaking</li>
            <li>Sponsored formats coming soon</li>
          </ul>
          <a href={tournamentWaitlistUrl} class="button button-secondary" data-track="tournament_interest_click">Request Invite</a>
        </article>
      </div>
    </section>

    <section class="panel join" id="join">
      <h2>Join alpha waitlist</h2>
      <p>Drop your email + primary game for invite priority, or grab a Founder slot instantly via secure checkout above.</p>
      <form class="waitlist-form" id="waitlistForm" action="/api/waitlist" method="POST">
        <input type="hidden" name="source" value="cogcage-landing" />
        <label>
          Email
          <input type="email" name="email" autocomplete="email" placeholder="you@domain.com" required />
        </label>
        <label>
          Primary game
          <input type="text" name="game" placeholder="EA FC, NBA 2K, Madden, Chess..." required />
        </label>
        <button type="submit" class="button button-primary" data-track="waitlist_submit_click">Reserve My Spot</button>
      </form>
      <p class="form-status" id="waitlistStatus" aria-live="polite"></p>
      <p class="fine-print">By submitting, you agree to receive alpha updates and launch offers.</p>
    </section>
  </main>
</Layout>

<script is:inline>
  const key = 'cogcage_events';

  function saveLocalEvent(payload) {
    const previous = JSON.parse(localStorage.getItem(key) || '[]');
    previous.push(payload);
    localStorage.setItem(key, JSON.stringify(previous.slice(-100)));
  }

  async function track(eventName, meta = {}) {
    const payload = {
      event: eventName,
      page: window.location.pathname,
      source: 'cogcage-landing',
      email: localStorage.getItem('cogcage_email') || undefined,
      meta,
      at: new Date().toISOString(),
    };

    saveLocalEvent(payload);

    try {
      await fetch('/api/events', {
        method: 'POST',
        headers: {
          'content-type': 'application/json',
          Accept: 'application/json',
        },
        body: JSON.stringify(payload),
        keepalive: true,
      });
    } catch {
      // Never block UX on analytics writes.
    }
  }

  document.querySelectorAll('[data-track]').forEach((el) => {
    el.addEventListener('click', () => {
      const payload = {
        eventId: el.getAttribute('data-track') ?? undefined,
        href: el.getAttribute('href') ?? undefined,
        tier: el.getAttribute('data-checkout-tier') ?? undefined,
      };
      track('click', payload);
    });
  });

  const founderCheckoutForm = document.getElementById('founderCheckoutForm');

  if (founderCheckoutForm instanceof HTMLFormElement) {
    const founderEmailInput = founderCheckoutForm.querySelector('input[name="email"]');
    const savedEmail = localStorage.getItem('cogcage_email');
    if (founderEmailInput instanceof HTMLInputElement && savedEmail) {
      founderEmailInput.value = savedEmail;
    }

    founderCheckoutForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      const submitButton = founderCheckoutForm.querySelector('button[type="submit"]');
      const emailField = founderCheckoutForm.querySelector('input[name="email"]');
      const checkoutUrl = founderCheckoutForm.dataset.checkoutUrl;

      if (!(emailField instanceof HTMLInputElement) || !checkoutUrl) return;

      const email = emailField.value.trim().toLowerCase();
      if (!email) return;

      submitButton?.setAttribute('disabled', 'true');

      try {
        await fetch('/api/founder-intent', {
          method: 'POST',
          headers: {
            'content-type': 'application/json',
            Accept: 'application/json',
          },
          body: JSON.stringify({ email, source: 'founder-checkout' }),
        });
      } catch {
        // Intent logging should not block checkout.
      }

      localStorage.setItem('cogcage_email', email);
      track('checkout_intent', { tier: 'founder', emailCaptured: true, eventId: 'founder_checkout_click' });

      const checkout = new URL(checkoutUrl, window.location.origin);
      checkout.searchParams.set('prefilled_email', email);
      window.open(checkout.toString(), '_blank', 'noopener,noreferrer');

      submitButton?.removeAttribute('disabled');
    });
  }

  const waitlistForm = document.getElementById('waitlistForm');
  const waitlistStatus = document.getElementById('waitlistStatus');

  if (waitlistForm instanceof HTMLFormElement) {
    const waitlistEmailInput = waitlistForm.querySelector('input[name="email"]');
    const savedEmail = localStorage.getItem('cogcage_email');
    if (waitlistEmailInput instanceof HTMLInputElement && savedEmail) {
      waitlistEmailInput.value = savedEmail;
    }

    waitlistForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const submitButton = waitlistForm.querySelector('button[type="submit"]');

      submitButton?.setAttribute('disabled', 'true');
      if (waitlistStatus) waitlistStatus.textContent = 'Submitting...';

      try {
        const response = await fetch(waitlistForm.action, {
          method: 'POST',
          body: new FormData(waitlistForm),
          headers: {
            Accept: 'application/json',
          },
        });

        if (!response.ok) {
          const payload = await response.json().catch(() => ({}));
          throw new Error(payload.error || 'Could not submit right now. Please try again.');
        }

        const emailField = waitlistForm.querySelector('input[name="email"]');
        if (emailField instanceof HTMLInputElement) {
          localStorage.setItem('cogcage_email', emailField.value.trim().toLowerCase());
        }

        track('waitlist_submit', { location: 'landing', eventId: 'waitlist_submit_click' });
        if (waitlistStatus) {
          waitlistStatus.textContent = 'You\'re in. Watch your inbox for alpha invite updates.';
        }
        waitlistForm.reset();
      } catch (error) {
        if (waitlistStatus) {
          waitlistStatus.textContent = error instanceof Error ? error.message : 'Submission failed. Please try again.';
        }
      } finally {
        submitButton?.removeAttribute('disabled');
      }
    });
  }

  track('landing_view', { page: 'home' });
</script>

<style>
  .shell {
    max-width: 1040px;
    margin: 0 auto;
    padding: 1.5rem 1.25rem 4rem;
  }

  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3rem;
  }

  .logo {
    text-decoration: none;
    font-weight: 900;
    letter-spacing: 0.1em;
  }

  .ghost {
    text-decoration: none;
    opacity: 0.9;
  }

  .hero h1 {
    font-size: clamp(2rem, 5vw, 3.8rem);
    margin: 0.4rem 0 1rem;
    line-height: 1.08;
    max-width: 14ch;
  }

  .eyebrow {
    color: #9ca5ff;
    font-size: 0.8rem;
    letter-spacing: 0.12em;
    font-weight: 700;
  }

  .subcopy {
    max-width: 58ch;
    color: #cfd3ee;
    line-height: 1.55;
    font-size: 1.06rem;
  }

  .cta-row {
    display: flex;
    gap: 0.8rem;
    flex-wrap: wrap;
    margin: 1.6rem 0 2rem;
  }

  .button {
    border: 0;
    text-decoration: none;
    border-radius: 999px;
    padding: 0.72rem 1.2rem;
    font-weight: 700;
    cursor: pointer;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    transition: transform 0.16s ease;
  }

  .button:hover {
    transform: translateY(-1px);
  }

  .button-primary {
    background: linear-gradient(135deg, #8a8fff 0%, #5d6bff 100%);
    color: white;
  }

  .button-secondary {
    background: rgba(255, 255, 255, 0.08);
    color: #f4f5ff;
    border: 1px solid rgba(255, 255, 255, 0.16);
  }

  .stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
    gap: 0.8rem;
    margin-top: 2rem;
  }

  .stats article {
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 0.8rem;
    padding: 0.9rem;
    background: rgba(255, 255, 255, 0.03);
  }

  .stats strong {
    display: block;
    margin-bottom: 0.3rem;
  }

  .stats span {
    color: #c9cee9;
    font-size: 0.95rem;
  }

  .panel {
    margin-top: 2.6rem;
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 1rem;
    padding: 1.4rem;
    background: rgba(255, 255, 255, 0.03);
  }

  .panel h2 {
    margin-top: 0;
  }

  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }

  .card {
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.13);
    border-radius: 0.85rem;
    padding: 1rem;
  }

  .card-highlight {
    border-color: rgba(138, 143, 255, 0.7);
    box-shadow: inset 0 0 0 1px rgba(138, 143, 255, 0.24);
  }

  .price {
    font-size: 1.55rem;
    font-weight: 800;
    margin: 0.4rem 0 0.8rem;
  }

  .price span {
    font-size: 0.9rem;
    font-weight: 500;
    opacity: 0.75;
    margin-left: 0.2rem;
  }

  ul {
    margin: 0 0 1rem;
    padding-left: 1.2rem;
    color: #d2d5ec;
    line-height: 1.45;
  }

  .founder-checkout-form {
    display: grid;
    gap: 0.55rem;
  }

  .founder-checkout-form label {
    display: grid;
    gap: 0.35rem;
    font-size: 0.82rem;
    color: #d2d6f1;
  }

  .founder-checkout-form input {
    border-radius: 0.6rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 0.62rem 0.72rem;
    background: rgba(3, 3, 7, 0.8);
    color: #fff;
  }

  .join .waitlist-form {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 0.7rem;
    align-items: end;
  }

  .join label {
    display: grid;
    gap: 0.35rem;
    font-size: 0.88rem;
    color: #d2d6f1;
  }

  .join input {
    border-radius: 0.6rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 0.62rem 0.72rem;
    background: rgba(3, 3, 7, 0.8);
    color: #fff;
  }

  .form-status {
    min-height: 1.2rem;
    margin-top: 0.7rem;
    color: #cfd3ee;
    font-size: 0.9rem;
  }

  .button[disabled] {
    opacity: 0.65;
    pointer-events: none;
  }

  .fine-print {
    margin-top: 0.8rem;
    color: #acb2d9;
    font-size: 0.84rem;
  }

  @media (max-width: 780px) {
    .join .waitlist-form {
      grid-template-columns: 1fr;
    }

    .panel {
      padding: 1.1rem;
    }
  }
</style>
