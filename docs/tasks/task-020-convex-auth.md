# TASK-020 (Redo): Convex + Convex Auth — Player Accounts & Data Layer

*Decision: Convex replaces Redis for all persistent state. Convex Auth for player identity.*
*Written: 2026-02-28. Owner: Daedalus. Deployment: `https://intent-horse-742.convex.cloud`*

---

## Why Convex (not Auth.js + Redis)

The Molt Pit is real-time multiplayer. Every feature downstream — live tank state, molt results, ladder,
replay history, profile pages — needs reactive sync to all viewers. Convex gives us that for free.
Auth.js would just add sessions on top of a DIY real-time stack we'd still have to build.

Clean architecture split:
- **Cloudflare DO** → authoritative real-time tick loop (ephemeral, in-flight)
- **Convex** → all persistent state (players, shells, tanks, history, ladder)
- **Convex Auth** → player identity (GitHub OAuth + email magic links)
- **Redis (Upstash)** → FFA sessions only (ephemeral, high-churn, DO doesn't write to Convex for these yet)

---

## What This Task Builds

1. **Convex wired into TanStack Start** — `ConvexAuthProvider` wraps the router
2. **Convex Auth** — GitHub OAuth + email OTP (Resend magic links)
3. **Convex schema** — all persistent tables with proper indexes
4. **Data layer migration** — `armory.ts`, `lobby.ts`, `waitlist-redis.ts` → Convex mutations/queries
5. **Ownership enforcement** — shell belongs to its creator; tank host vs challenger isolation
6. **Sign-in page** — `/sign-in` route with GitHub + email options (already scaffolded)
7. **Player token** — JWT from Convex session, returned in API for plugin use (TASK-024 prerequisite)

---

## Environment Variables

### Already available (`.env.local`)
```
UPSTASH_REDIS_REST_URL=https://dear-titmouse-61773.upstash.io
UPSTASH_REDIS_REST_TOKEN=AfFNAAIncDEzOGUxMDFlOGE1NzY0OTMyOWIyYWNiNTFkODkwNzJlZnAxNjE3NzM
```

### Need to add — client + server
```
VITE_CONVEX_URL=https://intent-horse-742.convex.cloud
CONVEX_URL=https://intent-horse-742.convex.cloud
```

### Need to add — deploy (non-interactive CI/deploy)
```
CONVEX_DEPLOY_KEY=<from Convex dashboard → Settings → Deploy Keys>
```

### Need to add — Convex Auth (OAuth providers)
```
# GitHub OAuth App
# Create at: https://github.com/settings/developers → OAuth Apps → New OAuth App
# Homepage URL: https://themoltpit.com
# Authorization callback URL: https://intent-horse-742.convex.cloud/api/auth/callback/github
AUTH_GITHUB_ID=<client id>
AUTH_GITHUB_SECRET=<client secret>

# Resend (email magic links)
AUTH_RESEND_KEY=<from resend.com dashboard>

# JWT secret (generate: openssl rand -hex 32)
JWT_PRIVATE_KEY=<generated>
JWKS=<generated by npx @convex-dev/auth — auto-set>
```

### Convex dashboard env vars (set via npx convex env set OR dashboard UI)
These go into Convex's server-side environment (not Vercel):
```
AUTH_GITHUB_ID
AUTH_GITHUB_SECRET
AUTH_RESEND_KEY
SITE_URL=https://themoltpit.com
```

---

## Implementation Plan

### Step 1 — Install packages

```bash
cd web
npm install convex @convex-dev/auth @auth/core@0.37.0 @convex-dev/react-query @tanstack/react-query @tanstack/react-router-with-query
```

### Step 2 — Initialize Convex project (non-interactive, uses deploy key)

```bash
# Link to existing deployment
CONVEX_DEPLOY_KEY=<key> npx convex deploy --prod
```

This generates `convex/_generated/` and `convex.json`.

### Step 3 — Initialize Convex Auth

```bash
CONVEX_DEPLOY_KEY=<key> npx @convex-dev/auth
```

This generates:
- `convex/auth.ts` — auth config
- `convex/auth.config.ts` — provider list
- Sets `JWT_PRIVATE_KEY` and `JWKS` in Convex env

### Step 4 — Define Convex schema (`convex/schema.ts`)

```typescript
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";
import { authTables } from "@convex-dev/auth/server";

export default defineSchema({
  ...authTables,

  // Player profile — one per authenticated user
  players: defineTable({
    userId: v.id("users"),           // FK to authTables.users
    username: v.string(),             // display name
    hardness: v.number(),            // ELO rank (default 1000)
    moltsPlayed: v.number(),
    moltsWon: v.number(),
    createdAt: v.number(),
  }).index("by_userId", ["userId"])
    .index("by_hardness", ["hardness"]),

  // Shells (saved crawler loadouts) — owned by a player
  shells: defineTable({
    playerId: v.id("players"),       // owner
    name: v.string(),
    cards: v.array(v.string()),
    directive: v.string(),           // system prompt
    skills: v.array(v.string()),     // selected claws
    stats: v.object({
      totalWeight: v.number(),
      totalOverhead: v.number(),
      armorValue: v.number(),
    }),
    createdAt: v.number(),
    updatedAt: v.number(),
  }).index("by_playerId", ["playerId"]),

  // Tanks — 1v1 match rooms, owned by host
  tanks: defineTable({
    hostPlayerId: v.id("players"),
    challengerPlayerId: v.optional(v.id("players")),
    hostShellId: v.id("shells"),
    challengerShellId: v.optional(v.id("shells")),
    status: v.union(
      v.literal("waiting"),
      v.literal("ready"),
      v.literal("active"),
      v.literal("complete"),
    ),
    moltId: v.optional(v.string()),   // Cloudflare DO molt ID
    createdAt: v.number(),
  }).index("by_status", ["status"])
    .index("by_hostPlayerId", ["hostPlayerId"]),

  // Molt history — record of every completed molt
  molts: defineTable({
    tankId: v.optional(v.id("tanks")),
    winnerId: v.optional(v.id("players")),
    loserId: v.optional(v.id("players")),
    winnerShellId: v.optional(v.id("shells")),
    loserShellId: v.optional(v.id("shells")),
    durationMs: v.number(),
    tickCount: v.number(),
    replayUrl: v.optional(v.string()),
    completedAt: v.number(),
  }).index("by_completedAt", ["completedAt"])
    .index("by_winnerId", ["winnerId"])
    .index("by_loserId", ["loserId"]),

  // Waitlist — email captures (Redis waitlist migrated here)
  waitlist: defineTable({
    email: v.string(),
    source: v.optional(v.string()),
    signedUpAt: v.number(),
  }).index("by_email", ["email"]),
});
```

### Step 5 — Convex Auth config (`convex/auth.ts`)

```typescript
import GitHub from "@auth/core/providers/github";
import Resend from "@auth/core/providers/resend";
import { convexAuth } from "@convex-dev/auth/server";

export const { auth, signIn, signOut, store } = convexAuth({
  providers: [
    GitHub({
      clientId: process.env.AUTH_GITHUB_ID,
      clientSecret: process.env.AUTH_GITHUB_SECRET,
    }),
    Resend({
      apiKey: process.env.AUTH_RESEND_KEY,
      from: "noreply@themoltpit.com",
    }),
  ],
});
```

### Step 6 — Convex HTTP router (`convex/http.ts`)

```typescript
import { httpRouter } from "convex/server";
import { auth } from "./auth";

const http = httpRouter();
auth.addHttpRoutes(http);
export default http;
```

### Step 7 — Update `app/router.tsx`

Replace `ConvexProvider` setup with `ConvexAuthProvider` + `ConvexQueryClient`:

```typescript
import { ConvexQueryClient } from "@convex-dev/react-query";
import { ConvexAuthProvider } from "@convex-dev/auth/react";

const CONVEX_URL = (import.meta as any).env.VITE_CONVEX_URL!;
const convexClient = new ConvexReactClient(CONVEX_URL);
const convexQueryClient = new ConvexQueryClient(CONVEX_URL);

// Wrap router with ConvexAuthProvider (wraps ConvexProvider)
Wrap: ({ children }) => (
  <ConvexAuthProvider client={convexClient}>
    {children}
  </ConvexAuthProvider>
)
```

### Step 8 — Convex query/mutation files

**`convex/players.ts`** — player profile CRUD
- `query: getPlayer(userId)` — get player by auth userId
- `mutation: upsertPlayer()` — create or update on sign-in

**`convex/shells.ts`** — shell management
- `query: listShells()` — returns caller's shells (auth-gated)
- `mutation: createShell(name, cards, directive, skills)` — auth-gated, sets playerId
- `mutation: updateShell(shellId, ...)` — auth-gated, validates caller owns it
- `mutation: deleteShell(shellId)` — auth-gated, validates ownership

**`convex/tanks.ts`** — tank (lobby) management
- `query: listOpenTanks()` — tanks with status=waiting
- `query: getTank(tankId)` — single tank details
- `mutation: createTank(hostShellId)` — auth-gated, sets hostPlayerId
- `mutation: joinTank(tankId, challengerShellId)` — auth-gated, sets challengerPlayerId
- `mutation: updateChallengerShell(tankId, shellId)` — only challenger can call
- `mutation: startMolt(tankId)` — only host can call, calls DO to start

**`convex/waitlist.ts`** — email capture
- `mutation: addToWaitlist(email, source?)` — idempotent by email

**`convex/ladder.ts`** — leaderboard
- `query: getTopPlayers(limit?)` — sorted by hardness desc

### Step 9 — Update API routes

Migrate these from Redis → Convex:
- `app/routes/api/shell.ts` + `shell.$id.ts` → call Convex mutations server-side
- `app/routes/api/tank.ts` + `tank.$id.*.ts` → Convex mutations
- `app/routes/api/waitlist.ts` → Convex mutation (keep Redis as secondary fallback)

Server-side Convex calls use `ConvexHttpClient`:
```typescript
import { ConvexHttpClient } from "convex/browser";
import { api } from "../../convex/_generated/api";

const convex = new ConvexHttpClient(process.env.CONVEX_URL!);
// Must pass auth token from request headers to Convex for authed mutations
```

For authenticated mutations server-side, pass the Convex session token from the cookie/header.

### Step 10 — Sign-in page (`app/routes/sign-in.tsx`)

Replace placeholder with:
```tsx
import { useAuthActions } from "@convex-dev/auth/react";

function SignIn() {
  const { signIn } = useAuthActions();
  return (
    <div>
      <button onClick={() => signIn("github")}>Sign in with GitHub</button>
      <EmailOTPForm />
    </div>
  );
}
```

### Step 11 — Auth guard in components

```tsx
import { useConvexAuth } from "convex/react";

function Shell() {
  const { isAuthenticated, isLoading } = useConvexAuth();
  if (!isAuthenticated) return <Redirect to="/sign-in" />;
  // ...
}
```

### Step 12 — Player token endpoint (for OpenClaw plugin)

```typescript
// app/routes/api/player-token.ts
// Returns the Convex session JWT for the authenticated player
// Plugin uses this to authenticate agent.external calls
```

---

## Ownership Enforcement Rules (TASK-021)

Enforced at the Convex mutation level — not at the API route level:

| Action | Who can do it |
|---|---|
| Update a shell | `shell.playerId === caller.playerId` |
| Delete a shell | `shell.playerId === caller.playerId` |
| Update host shell in tank | `tank.hostPlayerId === caller.playerId` |
| Update challenger shell in tank | `tank.challengerPlayerId === caller.playerId` |
| Start a molt | `tank.hostPlayerId === caller.playerId` AND `tank.status === 'ready'` |
| Join a tank | Caller is not already host |

Mutations throw `ConvexError("Unauthorized")` on violation → API returns 403.

---

## File Changes Summary

### New files
```
web/convex/schema.ts
web/convex/auth.ts
web/convex/auth.config.ts
web/convex/http.ts
web/convex/players.ts
web/convex/shells.ts
web/convex/tanks.ts
web/convex/waitlist.ts
web/convex/ladder.ts
web/convex/molts.ts
```

### Modified files
```
web/package.json                 — add convex packages
web/app/router.tsx               — ConvexAuthProvider + ConvexQueryClient
web/app/routes/__root.tsx        — QueryClient context
web/app/routes/sign-in.tsx       — real sign-in UI
web/app/routes/shell.tsx         — useQuery(api.shells.list)
web/app/routes/api/shell.ts      — Convex mutation calls
web/app/routes/api/shell.$id.ts  — ownership check
web/app/routes/api/tank.ts       — Convex mutation
web/app/routes/api/tank.$id.ts   — Convex query
web/app/routes/api/tank.$id.join.ts    — joinTank mutation
web/app/routes/api/tank.$id.start.ts   — startMolt mutation (host only)
web/app/routes/api/waitlist.ts   — Convex mutation + Redis fallback
web/.env.local                   — VITE_CONVEX_URL + CONVEX_URL
```

### Keep unchanged (Redis still used)
```
web/app/lib/session.ts          — FFA sessions (ephemeral, not migrated yet)
web/app/lib/redis.ts            — still used for FFA sessions
web/app/routes/api/sessions.*   — still Redis-backed for now
```

---

## Done When

- [ ] `npm run build` passes with Convex integrated
- [ ] Sign in with GitHub works end-to-end (creates player record in Convex)
- [ ] Shell CRUD is auth-gated (create, read own shells, can't read others')
- [ ] Tank creation sets `hostPlayerId = caller.id`
- [ ] Challenger joining sets `challengerPlayerId = caller.id`
- [ ] Attempting to edit opponent's shell in a tank returns 403
- [ ] Waitlist signup writes to Convex (email dedup)
- [ ] `GET /api/player-token` returns session JWT for authenticated player
- [ ] Deployed to Vercel with Convex env vars set

---

## What Aleks Needs to Provide

Before the agent can deploy Convex functions, we need:

1. **CONVEX_DEPLOY_KEY** → go to https://dashboard.convex.dev → select `intent-horse-742` project → Settings → Deploy Keys → Generate
2. **GitHub OAuth App** → https://github.com/settings/developers → OAuth Apps → New:
   - Homepage: `https://themoltpit.com`
   - Callback: `https://intent-horse-742.convex.cloud/api/auth/callback/github`
   → copy `Client ID` and `Client Secret`
3. **Resend API key** (optional for now — can skip, do GitHub only first) → https://resend.com → API Keys
4. **AUTH_SECRET** — generate: `openssl rand -hex 32`
